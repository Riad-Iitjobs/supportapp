<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - SupportHub</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Admin-specific styles */
    .admin-tabs {
      display: flex;
      background: var(--surface);
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: var(--header-height);
      z-index: 50;
    }

    .admin-tab {
      flex: 1;
      padding: var(--space-md);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: var(--transition);
      font-size: 0.875rem;
    }

    .admin-tab.active {
      color: var(--primary);
    }

    .admin-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .tab-content-wrapper {
      display: none;
    }

    .tab-content-wrapper.active {
      display: block;
    }

    /* Dashboard Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: 0 1px 3px var(--shadow);
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: var(--space-xs);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    /* Search and filters */
    .controls-bar {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
    }

    .search-input {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }

    .filters {
      display: flex;
      gap: var(--space-sm);
      overflow-x: auto;
    }

    .filter-btn {
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-full);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition);
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Tickets table */
    .tickets-table {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .ticket-row {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .ticket-row:hover {
      box-shadow: 0 2px 8px var(--shadow);
    }

    .ticket-row-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-xs);
    }

    .ticket-subject {
      font-weight: 600;
      font-size: 0.875rem;
      flex: 1;
      margin-right: var(--space-sm);
    }

    .ticket-status {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-open {
      background: rgba(79, 70, 229, 0.1);
      color: var(--primary);
    }

    .status-in-progress {
      background: rgba(245, 158, 11, 0.1);
      color: #D97706;
    }

    .status-resolved {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }

    .status-closed {
      background: rgba(107, 114, 128, 0.1);
      color: var(--text-secondary);
    }

    .ticket-meta {
      display: flex;
      gap: var(--space-md);
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .ticket-user {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Chat threads */
    .chat-threads {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .chat-thread {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .chat-thread:hover {
      box-shadow: 0 2px 8px var(--shadow);
    }

    .chat-thread-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-xs);
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
    }

    .chat-thread-info {
      flex: 1;
    }

    .chat-thread-name {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 2px;
    }

    .chat-thread-preview {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .chat-message-count {
      padding: 4px 8px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Chat detail view */
    .chat-detail {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-top: var(--space-md);
    }

    .chat-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border);
    }

    .chat-messages-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      max-height: 400px;
      overflow-y: auto;
    }

    .chat-msg {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .chat-msg.user {
      align-items: flex-end;
    }

    .chat-msg-bubble {
      background: var(--background);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      max-width: 80%;
    }

    .chat-msg.user .chat-msg-bubble {
      background: var(--primary);
      color: white;
    }

    .chat-msg-time {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-xl);
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <!-- Header -->
    <header class="header">
      <h1 class="header-title">Admin Panel</h1>
      <div class="header-actions">
        <button class="icon-btn" onclick="logout()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Admin Tabs -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="admin-tab" onclick="switchTab('tickets')">Tickets</button>
      <button class="admin-tab" onclick="switchTab('chats')">Chats</button>
    </div>

    <!-- Main Admin Content -->
    <main class="main-content">
      <!-- Dashboard Tab -->
      <div class="tab-content-wrapper active" id="dashboard-tab">
        <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: var(--space-lg);">Overview</h2>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Total Tickets</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-open">0</div>
            <div class="stat-label">Open</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-progress">0</div>
            <div class="stat-label">In Progress</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-resolved">0</div>
            <div class="stat-label">Resolved</div>
          </div>
        </div>

        <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: var(--space-md);">Recent Activity</h3>
        <div id="recent-tickets"></div>
      </div>

      <!-- All Tickets Tab -->
      <div class="tab-content-wrapper" id="tickets-tab">
        <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: var(--space-lg);">All Tickets</h2>

        <div class="controls-bar">
          <input
            type="text"
            class="search-input"
            id="ticket-search"
            placeholder="Search by subject, user, or email..."
            oninput="filterTickets()"
          >
          <div class="filters">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
            <button class="filter-btn" data-filter="open" onclick="setFilter('open')">Open</button>
            <button class="filter-btn" data-filter="in-progress" onclick="setFilter('in-progress')">In Progress</button>
            <button class="filter-btn" data-filter="resolved" onclick="setFilter('resolved')">Resolved</button>
            <button class="filter-btn" data-filter="closed" onclick="setFilter('closed')">Closed</button>
          </div>
        </div>

        <div class="tickets-table" id="all-tickets"></div>
      </div>

      <!-- All Chats Tab -->
      <div class="tab-content-wrapper" id="chats-tab">
        <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: var(--space-lg);">User Conversations</h2>
        <div class="chat-threads" id="chat-threads"></div>
        <div id="chat-detail-container"></div>
      </div>
    </main>
  </div>

  <script src="app.js"></script>
  <script src="admin-data.js"></script>
  <script>
    // Check admin session
    const adminSession = JSON.parse(localStorage.getItem('adminSession') || '{}');
    if (!adminSession.isAdmin) {
      window.location.href = 'admin-login.html';
    }

    let currentFilter = 'all';
    let allTickets = [];

    // Get all tickets
    function getAllTickets() {
      const localTickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      return [...DUMMY_TICKETS, ...localTickets];
    }

    // Get all users
    function getAllUsers() {
      const realUsers = JSON.parse(localStorage.getItem('realUsers') || '[]');
      return [...DUMMY_USERS, ...realUsers];
    }

    // Get user by ID
    function getUserById(userId) {
      const allUsers = getAllUsers();
      return allUsers.find(u => u.id === userId) || { name: 'Unknown User', email: 'unknown@example.com', initials: 'U' };
    }

    // Switch tabs
    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.admin-tab').forEach(t => {
        t.classList.toggle('active', t.textContent.toLowerCase().includes(tab));
      });

      // Update tab content
      document.querySelectorAll('.tab-content-wrapper').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');

      // Load tab content
      if (tab === 'dashboard') loadDashboard();
      if (tab === 'tickets') loadAllTickets();
      if (tab === 'chats') loadAllChats();
    }

    // Load Dashboard
    function loadDashboard() {
      allTickets = getAllTickets();

      const stats = {
        total: allTickets.length,
        open: allTickets.filter(t => t.status === 'open').length,
        progress: allTickets.filter(t => t.status === 'in-progress').length,
        resolved: allTickets.filter(t => t.status === 'resolved').length
      };

      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-open').textContent = stats.open;
      document.getElementById('stat-progress').textContent = stats.progress;
      document.getElementById('stat-resolved').textContent = stats.resolved;

      // Show recent 5 tickets
      const recentTickets = [...allTickets]
        .sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date))
        .slice(0, 5);

      const recentHTML = recentTickets.map(ticket => {
        const user = getUserById(ticket.userId);
        return `
          <div class="ticket-row" onclick="viewTicketDetail(${ticket.id})">
            <div class="ticket-row-header">
              <div class="ticket-subject">${ticket.subject}</div>
              <span class="ticket-status status-${ticket.status}">${ticket.status.replace('-', ' ')}</span>
            </div>
            <div class="ticket-meta">
              <span class="ticket-user">${user.name}</span>
              <span>${ticket.date}</span>
              <span>${ticket.category}</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('recent-tickets').innerHTML = recentHTML || '<div class="empty-state">No tickets yet</div>';
    }

    // Load All Tickets
    function loadAllTickets() {
      allTickets = getAllTickets();
      filterTickets();
    }

    // Set filter
    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      filterTickets();
    }

    // Filter tickets
    function filterTickets() {
      const searchTerm = document.getElementById('ticket-search').value.toLowerCase();

      let filtered = allTickets;

      // Apply status filter
      if (currentFilter !== 'all') {
        filtered = filtered.filter(t => t.status === currentFilter);
      }

      // Apply search filter
      if (searchTerm) {
        filtered = filtered.filter(t => {
          const user = getUserById(t.userId);
          return t.subject.toLowerCase().includes(searchTerm) ||
                 user.name.toLowerCase().includes(searchTerm) ||
                 user.email.toLowerCase().includes(searchTerm) ||
                 t.category.toLowerCase().includes(searchTerm);
        });
      }

      // Sort by newest first
      filtered.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

      // Render
      const ticketsHTML = filtered.map(ticket => {
        const user = getUserById(ticket.userId);
        return `
          <div class="ticket-row" onclick="viewTicketDetail(${ticket.id})">
            <div class="ticket-row-header">
              <div class="ticket-subject">${ticket.subject}</div>
              <span class="ticket-status status-${ticket.status}">${ticket.status.replace('-', ' ')}</span>
            </div>
            <div class="ticket-meta">
              <span class="ticket-user">${user.name}</span>
              <span>${user.email}</span>
              <span>${ticket.date}</span>
              <span>${ticket.category}</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('all-tickets').innerHTML = ticketsHTML || '<div class="empty-state">No tickets found</div>';
    }

    // View ticket detail
    function viewTicketDetail(ticketId) {
      const ticket = allTickets.find(t => t.id === ticketId);
      if (!ticket) return;

      const user = getUserById(ticket.userId);
      alert(`Ticket Details\n\nFrom: ${user.name} (${user.email})\nSubject: ${ticket.subject}\nCategory: ${ticket.category}\nPriority: ${ticket.priority}\nStatus: ${ticket.status}\nDate: ${ticket.date}\n\nDescription:\n${ticket.description || 'No description provided'}`);
    }

    // Load All Chats
    function loadAllChats() {
      const userChats = JSON.parse(localStorage.getItem('userChats') || '{}');
      const allUsers = getAllUsers();

      // Get users who have chat history
      const usersWithChats = Object.keys(userChats).map(userId => {
        const user = getUserById(parseInt(userId));
        const messages = userChats[userId] || [];
        const lastMessage = messages[messages.length - 1];

        return {
          userId: parseInt(userId),
          user,
          messages,
          messageCount: messages.length,
          lastMessage: lastMessage ? lastMessage.text : 'No messages',
          lastTime: lastMessage ? lastMessage.timestamp : null
        };
      }).filter(u => u.messageCount > 0);

      // Sort by last message time
      usersWithChats.sort((a, b) => {
        if (!a.lastTime) return 1;
        if (!b.lastTime) return -1;
        return new Date(b.lastTime) - new Date(a.lastTime);
      });

      const threadsHTML = usersWithChats.map(chat => `
        <div class="chat-thread" onclick="viewChat(${chat.userId})">
          <div class="chat-thread-header">
            <div class="chat-avatar">${chat.user.initials}</div>
            <div class="chat-thread-info">
              <div class="chat-thread-name">${chat.user.name}</div>
              <div class="chat-thread-preview">${chat.lastMessage.substring(0, 50)}${chat.lastMessage.length > 50 ? '...' : ''}</div>
            </div>
            <span class="chat-message-count">${chat.messageCount}</span>
          </div>
        </div>
      `).join('');

      document.getElementById('chat-threads').innerHTML = threadsHTML || '<div class="empty-state">No chat conversations yet</div>';
    }

    // View chat conversation
    function viewChat(userId) {
      const userChats = JSON.parse(localStorage.getItem('userChats') || '{}');
      const messages = userChats[userId] || [];
      const user = getUserById(userId);

      const messagesHTML = messages.map(msg => `
        <div class="chat-msg ${msg.isUser ? 'user' : ''}">
          <div class="chat-msg-bubble">${msg.text}</div>
          <div class="chat-msg-time">${new Date(msg.timestamp).toLocaleString()}</div>
        </div>
      `).join('');

      const chatDetailHTML = `
        <div class="chat-detail">
          <div class="chat-detail-header">
            <div>
              <strong>${user.name}</strong>
              <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.email}</div>
            </div>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="loadAllChats()">Close</button>
          </div>
          <div class="chat-messages-list">${messagesHTML}</div>
        </div>
      `;

      document.getElementById('chat-detail-container').innerHTML = chatDetailHTML;
    }

    // Logout
    function logout() {
      localStorage.removeItem('adminSession');
      window.location.href = 'admin-login.html';
    }

    // Initialize
    loadDashboard();
  </script>
</body>
</html>
